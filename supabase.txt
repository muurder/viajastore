
-- =============================================================================
-- SCRIPT DE CORREÇÃO DEFINITIVA DO BANCO DE DADOS
-- Execute este script no SQL Editor do Supabase para corrigir tabelas, chaves e permissões.
-- =============================================================================

-- 1. CRIAR COLUNAS QUE PODEM ESTAR FALTANDO
ALTER TABLE public.agencies ADD COLUMN IF NOT EXISTS subscription_expires_at TIMESTAMP WITH TIME ZONE;
ALTER TABLE public.agencies ADD COLUMN IF NOT EXISTS subscription_plan TEXT DEFAULT 'BASIC';
ALTER TABLE public.agencies ADD COLUMN IF NOT EXISTS subscription_status TEXT DEFAULT 'INACTIVE';
ALTER TABLE public.agencies ADD COLUMN IF NOT EXISTS deleted_at TIMESTAMP WITH TIME ZONE;
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS deleted_at TIMESTAMP WITH TIME ZONE;

-- 2. FUNÇÃO SEGURA PARA CHECAR ADMIN (Evita Recursão Infinita)
CREATE OR REPLACE FUNCTION public.is_admin()
RETURNS BOOLEAN
LANGUAGE sql
SECURITY DEFINER
SET search_path = public
AS $$
  SELECT EXISTS (
    SELECT 1 FROM public.profiles
    WHERE id = auth.uid() AND role = 'ADMIN'
  );
$$;

-- 3. REMOVER TODAS AS POLÍTICAS POSSÍVEIS (LIMPEZA TOTAL)
DROP POLICY IF EXISTS "Admin Manage All Profiles" ON public.profiles;
DROP POLICY IF EXISTS "Public Read Profiles" ON public.profiles;
DROP POLICY IF EXISTS "Users Update Own Profile" ON public.profiles;
DROP POLICY IF EXISTS "Users Insert Own Profile" ON public.profiles;
DROP POLICY IF EXISTS "Users Delete Own Profile" ON public.profiles;

DROP POLICY IF EXISTS "Admin Manage All Agencies" ON public.agencies;
DROP POLICY IF EXISTS "Public Read Agencies" ON public.agencies;
DROP POLICY IF EXISTS "Agency Update Self" ON public.agencies;

DROP POLICY IF EXISTS "Admin Full Access Activity Logs" ON public.activity_logs;
DROP POLICY IF EXISTS "Authenticated Users Can View Own Activity Logs" ON public.activity_logs;
DROP POLICY IF EXISTS "Authenticated Users Can Insert Own Activity Logs" ON public.activity_logs;

DROP POLICY IF EXISTS "Admin Full Access Audit Logs" ON public.audit_logs;
DROP POLICY IF EXISTS "Authenticated Read Audit Logs" ON public.audit_logs;

-- NEW: Drop policies for the 'reviews' table
DROP POLICY IF EXISTS "Admin Full Access Reviews" ON public.reviews;
DROP POLICY IF EXISTS "Authenticated Read Reviews" ON public.reviews;

-- NEW: Drop the view before recreating it to avoid column rename errors
DROP VIEW IF EXISTS public.agency_trips_with_cover;

-- 4. APLICAR AS POLÍTICAS DEFINITIVAS

-- --- PROFILES ---
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;

-- Admin Total (Usa função segura)
CREATE POLICY "Admin Manage All Profiles" ON public.profiles
FOR ALL
USING ( public.is_admin() );

-- Leitura Pública
CREATE POLICY "Public Read Profiles" ON public.profiles
FOR SELECT
USING ( true );

-- Usuário Edita a Si Mesmo
CREATE POLICY "Users Update Own Profile" ON public.profiles
FOR UPDATE
USING ( auth.uid() = id );

-- Usuário Insere a Si Mesmo (Cadastro)
CREATE POLICY "Users Insert Own Profile" ON public.profiles
FOR INSERT
WITH CHECK ( auth.uid() = id );

-- Usuário Deleta a Si Mesmo
CREATE POLICY "Users Delete Own Profile" ON public.profiles
FOR DELETE
USING ( auth.uid() = id );


-- --- AGENCIES ---
ALTER TABLE public.agencies ENABLE ROW LEVEL SECURITY;

-- Admin Total
CREATE POLICY "Admin Manage All Agencies" ON public.agencies
FOR ALL
USING ( is_admin() );

-- Leitura Pública
CREATE POLICY "Public Read Agencies" ON public.agencies
FOR SELECT
USING ( true );

-- Agência Edita a Si Mesma
CREATE POLICY "Agency Update Self" ON public.agencies
FOR UPDATE
USING ( auth.uid() = user_id );

-- 5. CORRIGIR CONSTRAINTS COM CASCADE (Para permitir deleção)
-- Remove antigas se existirem
ALTER TABLE public.agencies DROP CONSTRAINT IF EXISTS agencies_user_id_fkey;
ALTER TABLE public.trips DROP CONSTRAINT IF EXISTS trips_agency_id_fkey;
ALTER TABLE public.bookings DROP CONSTRAINT IF EXISTS bookings_trip_id_fkey;
ALTER TABLE public.bookings DROP CONSTRAINT IF EXISTS bookings_client_id_fkey;
ALTER TABLE public.trip_images DROP CONSTRAINT IF EXISTS trip_images_trip_id_fkey;
ALTER TABLE public.agency_reviews DROP CONSTRAINT IF EXISTS agency_reviews_agency_id_fkey;
ALTER TABLE public.agency_reviews DROP CONSTRAINT IF EXISTS agency_reviews_client_id_fkey;
ALTER TABLE public.favorites DROP CONSTRAINT IF EXISTS favorites_user_id_fkey;
ALTER TABLE public.favorites DROP CONSTRAINT IF EXISTS favorites_trip_id_fkey;
ALTER TABLE public.agency_themes DROP CONSTRAINT IF EXISTS agency_themes_agency_id_fkey;


-- Recria com CASCADE
ALTER TABLE public.agencies ADD CONSTRAINT agencies_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.profiles(id) ON DELETE CASCADE;
ALTER TABLE public.trips ADD CONSTRAINT trips_agency_id_fkey FOREIGN KEY (agency_id) REFERENCES public.agencies(id) ON DELETE CASCADE;
ALTER TABLE public.bookings ADD CONSTRAINT bookings_trip_id_fkey FOREIGN KEY (trip_id) REFERENCES public.trips(id) ON DELETE CASCADE;
ALTER TABLE public.bookings ADD CONSTRAINT bookings_client_id_fkey FOREIGN KEY (client_id) REFERENCES public.profiles(id) ON DELETE CASCADE;
ALTER TABLE public.trip_images ADD CONSTRAINT trip_images_trip_id_fkey FOREIGN KEY (trip_id) REFERENCES public.trips(id) ON DELETE CASCADE;
ALTER TABLE public.agency_reviews ADD CONSTRAINT agency_reviews_agency_id_fkey FOREIGN KEY (agency_id) REFERENCES public.agencies(id) ON DELETE CASCADE;
ALTER TABLE public.agency_reviews ADD CONSTRAINT agency_reviews_client_id_fkey FOREIGN KEY (client_id) REFERENCES public.profiles(id) ON DELETE CASCADE;
ALTER TABLE public.favorites ADD CONSTRAINT favorites_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.profiles(id) ON DELETE CASCADE;
ALTER TABLE public.favorites ADD CONSTRAINT favorites_trip_id_fkey FOREIGN KEY (trip_id) REFERENCES public.trips(id) ON DELETE CASCADE;
ALTER TABLE public.agency_themes ADD CONSTRAINT agency_themes_agency_id_fkey FOREIGN KEY (agency_id) REFERENCES public.agencies(id) ON DELETE CASCADE;

-- 6. CRIAR FUNÇÃO RPC DE CRIAÇÃO (Se não existir)
-- Removendo a função antes de criá-la para evitar erros se a definição mudou
DROP FUNCTION IF EXISTS public.create_agency(uuid, text, text, text, text, text);
CREATE OR REPLACE FUNCTION public.create_agency(
  p_user_id uuid,
  p_name text,
  p_email text,
  p_phone text,
  p_whatsapp text,
  p_slug text
)
RETURNS public.agencies
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
DECLARE
  new_agency public.agencies;
BEGIN
  INSERT INTO public.agencies (user_id, name, email, phone, whatsapp, slug, is_active, subscription_plan, subscription_status)
  VALUES (p_user_id, p_name, p_email, p_phone, p_whatsapp, p_slug, false, 'BASIC', 'INACTIVE')
  RETURNING * INTO new_agency;
  RETURN new_agency;
END;
$$;
GRANT EXECUTE ON FUNCTION public.create_agency(uuid, text, text, text, text, text) TO anon, authenticated, service_role;

-- 7. ADICIONAR FUNÇÃO RPC PARA ATIVAÇÃO/TROCA DE ASSINATURA
DROP FUNCTION IF EXISTS public.activate_agency_subscription(uuid,text);
CREATE OR REPLACE FUNCTION public.activate_agency_subscription(
  p_user_id uuid,
  p_plan_id text
)
RETURNS public.agencies
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
DECLARE
  v_duration_months INTEGER;
  v_expires_at TIMESTAMP WITH TIME ZONE;
  updated_agency public.agencies;
BEGIN
  -- Buscar a duração do plano na tabela 'plans'
  -- Assumindo que a tabela 'plans' tem colunas 'id' e 'duration_months'
  SELECT duration_months INTO v_duration_months
  FROM public.plans
  WHERE id = p_plan_id;

  -- Se duration_months for NULL ou 0, usar 1 mês como fallback
  IF v_duration_months IS NULL OR v_duration_months = 0 THEN
      v_duration_months := 1;
  END IF;

  -- Calcular a data de expiração
  v_expires_at := NOW() + (v_duration_months || ' month')::INTERVAL;
  
  -- Atualizar a agência
  UPDATE public.agencies
  SET
    subscription_plan = p_plan_id,
    subscription_status = 'ACTIVE',
    subscription_expires_at = v_expires_at,
    is_active = TRUE,
    updated_at = NOW()
  WHERE user_id = p_user_id
  RETURNING * INTO updated_agency;

  -- Se a agência não for encontrada, lançar um erro
  IF NOT FOUND THEN
    RAISE EXCEPTION 'Agência não encontrada para o user_id: %', p_user_id;
  END IF;

  RETURN updated_agency;
END;
$$;
GRANT EXECUTE ON FUNCTION public.activate_agency_subscription(uuid, text) TO anon, authenticated, service_role;


-- =============================================================================
-- NOVO: TABELA DE LOGS DE ATIVIDADE CENTRALIZADA
-- =============================================================================

CREATE TABLE IF NOT EXISTS public.activity_logs (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id uuid REFERENCES public.profiles(id) ON DELETE SET NULL, -- Quem realizou a ação
    agency_id uuid REFERENCES public.agencies(id) ON DELETE SET NULL, -- Se a ação está ligada a uma agência (ex: agência publicou uma viagem)
    actor_email text NOT NULL, -- Email do ator (denormalizado para persistência)
    actor_role text NOT NULL, -- Role do ator (CLIENT, AGENCY, ADMIN)
    action_type text NOT NULL, -- Tipo de ação (ex: BOOKING_CREATED, TRIP_VIEWED, AGENCY_PROFILE_UPDATED)
    details jsonb DEFAULT '{}'::jsonb, -- Detalhes específicos da ação (ex: {trip_id, new_status})
    created_at timestamp with time zone DEFAULT now()
);

ALTER TABLE public.activity_logs ENABLE ROW LEVEL SECURITY;

-- RLS: Admin pode ver e gerenciar todos os logs
DROP POLICY IF EXISTS "Admin Full Access Activity Logs" ON public.activity_logs;
CREATE POLICY "Admin Full Access Activity Logs" ON public.activity_logs
FOR ALL
USING ( public.is_admin() );

-- RLS: Usuário autenticado pode ver seus próprios logs
DROP POLICY IF EXISTS "Authenticated Users Can View Own Activity Logs" ON public.activity_logs;
CREATE POLICY "Authenticated Users Can View Own Activity Logs" ON public.activity_logs
FOR SELECT
USING ( auth.uid() = user_id );

-- RLS: Usuários autenticados podem inserir logs de suas próprias ações
DROP POLICY IF EXISTS "Authenticated Users Can Insert Own Activity Logs" ON public.activity_logs;
CREATE POLICY "Authenticated Users Can Insert Own Activity Logs" ON public.activity_logs
FOR INSERT
WITH CHECK ( auth.uid() = user_id OR public.is_admin() ); -- Admin também pode inserir logs para terceiros se necessário


-- =============================================================================
-- ATUALIZAÇÕES PARA AUDIT_LOGS (Se mantivermos essa tabela separada)
-- =============================================================================
ALTER TABLE public.audit_logs ENABLE ROW LEVEL SECURITY;

-- RLS: Admin Full Access for audit_logs
DROP POLICY IF EXISTS "Admin Full Access Audit Logs" ON public.audit_logs;
CREATE POLICY "Admin Full Access Audit Logs" ON public.audit_logs
FOR ALL
USING ( public.is_admin() );

-- RLS: Read-only for authenticated users (only if they are admin, otherwise no access)
-- This makes audit_logs exclusively for admins.
DROP POLICY IF EXISTS "Authenticated Read Audit Logs" ON public.audit_logs;
CREATE POLICY "Authenticated Read Audit Logs" ON public.audit_logs
FOR SELECT
USING ( public.is_admin() );

-- =============================================================================
-- NEW: RLS Policies for `public.reviews` table
-- This table is marked as DEPRECATED but has RLS enabled without policies.
-- Defaulting to authenticated read-only access to prevent default denial.
-- =============================================================================
ALTER TABLE public.reviews ENABLE ROW LEVEL SECURITY;

-- RLS: Admin Full Access Reviews
CREATE POLICY "Admin Full Access Reviews" ON public.reviews
FOR ALL
USING ( public.is_admin() );

-- RLS: Authenticated Read Reviews
-- Allowing all (even non-authenticated) to read old reviews. If only auth users should read, change to 'auth.uid() IS NOT NULL'.
CREATE POLICY "Authenticated Read Reviews" ON public.reviews
FOR SELECT
USING ( true );

-- =============================================================================
-- NEW: View agency_trips_with_cover as SECURITY INVOKER
-- This fixes the "Security Definer View" alert.
-- =============================================================================
CREATE OR REPLACE VIEW public.agency_trips_with_cover AS
SELECT
    t.id AS trip_id,
    t.title AS trip_title,
    t.slug AS trip_slug,
    t.description AS trip_description,
    t.destination AS trip_destination,
    t.price AS trip_price,
    t.start_date AS trip_start_date,
    t.end_date AS trip_end_date,
    t.duration_days AS trip_duration_days,
    t.category AS trip_category,
    t.tags AS trip_tags,
    t.traveler_types AS trip_traveler_types,
    t.is_active AS trip_is_active,
    t.featured AS trip_featured,
    t.featured_in_hero AS trip_featured_in_hero,
    t.popular_near_sp AS trip_popular_near_sp,
    t.views_count AS trip_views_count,
    t.sales_count AS trip_sales_count,
    t.created_at AS trip_created_at,
    t.updated_at AS trip_updated_at,
    a.id AS agency_pk_id, -- Primary key of agencies table
    a.user_id AS agency_user_id, -- Foreign key to profiles table
    a.name AS agency_name,
    a.slug AS agency_slug,
    a.logo_url AS agency_logo_url,
    a.email AS agency_email,
    a.whatsapp AS agency_whatsapp,
    (SELECT image_url FROM public.trip_images WHERE trip_id = t.id ORDER BY position LIMIT 1) AS cover_image_url
FROM
    public.trips t
JOIN
    public.agencies a ON t.agency_id = a.id;

-- 8. REFORÇAR PERMISSÃO DE ADMIN E DATAS
UPDATE public.profiles SET role = 'ADMIN' WHERE email = 'juannicolas1@gmail.com';

-- 9. RECARREGAR
NOTIFY pgrst, 'reload config';