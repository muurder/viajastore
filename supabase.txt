-- =============================================================================
-- SCRIPT DE CORREÇÃO DEFINITIVO PARA PERSISTÊNCIA DE DADOS (RLS) - VIAJASTORE ADMIN
-- =============================================================================
-- Problema: Ações no painel admin (ex: suspender agência) falham devido a um erro
-- de "recursão infinita" nas políticas de segurança (RLS) do Supabase.
--
-- Solução: Criar uma função `get_my_role()` com `SECURITY DEFINER` para ler o
-- papel do usuário de forma segura, sem disparar a RLS da tabela 'profiles' sobre
-- si mesma. Em seguida, atualizar as políticas para usar esta função e garantir
-- que as permissões para não-admins continuem funcionando.
-- =============================================================================

-- 1. Cria uma função segura para obter o 'role' do usuário atual.
-- A cláusula "SECURITY DEFINER" é crucial. Ela permite que a função leia a tabela
-- 'profiles' sem disparar as políticas de RLS da própria tabela, quebrando o ciclo
-- de recursão.
CREATE OR REPLACE FUNCTION get_my_role()
RETURNS TEXT AS $$
DECLARE
  user_role TEXT;
BEGIN
  -- Esta consulta é executada com os privilégios do criador da função,
  -- bypassando a RLS do usuário que a chama apenas para esta leitura.
  SELECT role INTO user_role
  FROM public.profiles
  WHERE id = auth.uid()
  LIMIT 1;
  RETURN user_role;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;


-- 2. Remove as políticas antigas para evitar conflitos e garantir uma base limpa.
DROP POLICY IF EXISTS "Enable full access for admins on agencies" ON public.agencies;
DROP POLICY IF EXISTS "Admin full access on agencies" ON public.agencies;
DROP POLICY IF EXISTS "Enable full access for admins on profiles" ON public.profiles;
DROP POLICY IF EXISTS "Admin full access on profiles" ON public.profiles;
DROP POLICY IF EXISTS "Agencies can manage their own agency record" ON public.agencies;
DROP POLICY IF EXISTS "Users can view their own profile" ON public.profiles;
DROP POLICY IF EXISTS "Users can update their own profile" ON public.profiles;
DROP POLICY IF EXISTS "Public can read agencies" ON public.agencies;


-- 3. Cria as políticas de ADMIN usando a nova função segura.
-- Concede permissão total para administradores nas tabelas 'agencies' e 'profiles'.
CREATE POLICY "Admin full access on agencies"
ON public.agencies
FOR ALL
USING ( get_my_role() = 'ADMIN' )
WITH CHECK ( get_my_role() = 'ADMIN' );

CREATE POLICY "Admin full access on profiles"
ON public.profiles
FOR ALL
USING ( get_my_role() = 'ADMIN' )
WITH CHECK ( get_my_role() = 'ADMIN' );


-- 4. Garante que outras políticas importantes coexistam.
-- As políticas de ADMIN acima são restritivas. É preciso garantir que os
-- usuários normais e agências ainda possam acessar e gerenciar seus próprios dados.

-- Agências podem gerenciar (ver e atualizar) seu próprio registro.
CREATE POLICY "Agencies can manage their own agency record"
ON public.agencies
FOR ALL
USING ( auth.uid() = id AND get_my_role() = 'AGENCY' )
WITH CHECK ( auth.uid() = id AND get_my_role() = 'AGENCY' );

-- Usuários (CLIENT) podem ver e atualizar seus próprios perfis.
CREATE POLICY "Users can view their own profile"
ON public.profiles
FOR SELECT
USING ( auth.uid() = id AND get_my_role() = 'CLIENT' );

CREATE POLICY "Users can update their own profile"
ON public.profiles
FOR UPDATE
USING ( auth.uid() = id AND get_my_role() = 'CLIENT' )
WITH CHECK ( auth.uid() = id AND get_my_role() = 'CLIENT' );


-- 5. Garante que agências ativas sejam publicamente visíveis.
-- Essencial para listagens públicas e perfis de agência.
CREATE POLICY "Public can read active agencies"
ON public.agencies
FOR SELECT
USING ( subscription_status = 'ACTIVE' AND deleted_at IS NULL );


-- 6. Habilita RLS nas tabelas (se ainda não estiver habilitado).
-- Se já estiver ativa, o comando não fará nada.
ALTER TABLE public.agencies ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;

-- =============================================================================
-- FIM DO SCRIPT
-- =============================================================================
