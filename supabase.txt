-- =============================================================================
-- SCRIPT DEFINITIVO DE POLÍTICAS DE SEGURANÇA (RLS) - VIAJASTORE V3
-- =============================================================================
-- Este script adiciona uma verificação de segurança para garantir que apenas
-- usuários que compraram de uma agência possam avaliá-la.
-- Mantém as políticas anteriores e é seguro de executar.
-- =============================================================================

-- 1. FUNÇÃO SEGURA PARA VERIFICAR O PAPEL DO USUÁRIO (Existente)
CREATE OR REPLACE FUNCTION get_my_role()
RETURNS TEXT AS $$
DECLARE
  user_role TEXT;
BEGIN
  -- Esta consulta é executada com privilégios elevados, bypassando a RLS.
  SELECT role INTO user_role
  FROM public.profiles
  WHERE id = auth.uid()
  LIMIT 1;
  RETURN user_role;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;


-- 2. NOVA FUNÇÃO: VERIFICA SE O USUÁRIO COMPROU DA AGÊNCIA
CREATE OR REPLACE FUNCTION has_purchased_from_agency(agency_id_to_check uuid)
RETURNS boolean AS $$
BEGIN
  RETURN EXISTS (
    SELECT 1
    FROM public.bookings b
    JOIN public.trips t ON b.trip_id = t.id
    WHERE b.client_id = auth.uid()
      AND t.agency_id = agency_id_to_check
      AND b.status = 'CONFIRMED'
  );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;


-- 3. LIMPEZA DE POLÍTICAS ANTIGAS (PARA GARANTIR UMA BASE LIMPA)
DROP POLICY IF EXISTS "Admin full access" ON public.agencies;
DROP POLICY IF EXISTS "Agencies can manage own record" ON public.agencies;
DROP POLICY IF EXISTS "Public can view active agencies" ON public.agencies;

DROP POLICY IF EXISTS "Admin full access" ON public.profiles;
DROP POLICY IF EXISTS "Users can manage own profile" ON public.profiles;

DROP POLICY IF EXISTS "Admin full access" ON public.trips;
DROP POLICY IF EXISTS "Agencies can manage their own trips" ON public.trips;
DROP POLICY IF EXISTS "Public can view active trips" ON public.trips;

-- Limpando políticas de 'agency_reviews' para recriá-las com mais granularidade
DROP POLICY IF EXISTS "Admin full access" ON public.agency_reviews;
DROP POLICY IF EXISTS "Public can view reviews" ON public.agency_reviews;
DROP POLICY IF EXISTS "Users can manage own reviews" ON public.agency_reviews;
DROP POLICY IF EXISTS "Clients can create reviews for agencies they purchased from" ON public.agency_reviews;
DROP POLICY IF EXISTS "Clients can update or delete their own reviews" ON public.agency_reviews;
DROP POLICY IF EXISTS "Clients can update their own reviews" ON public.agency_reviews;
DROP POLICY IF EXISTS "Clients can delete their own reviews" ON public.agency_reviews;

DROP POLICY IF EXISTS "Admin full access" ON public.themes;
DROP POLICY IF EXISTS "Authenticated users can view themes" ON public.themes;


-- 4. POLÍTICAS PARA A TABELA 'agencies' (Inalterado)
CREATE POLICY "Admin full access" ON public.agencies FOR ALL USING (get_my_role() = 'ADMIN') WITH CHECK (get_my_role() = 'ADMIN');
CREATE POLICY "Agencies can manage own record" ON public.agencies FOR ALL USING (auth.uid() = id) WITH CHECK (auth.uid() = id);
CREATE POLICY "Public can view active agencies" ON public.agencies FOR SELECT USING (subscription_status = 'ACTIVE' AND deleted_at IS NULL);


-- 5. POLÍTICAS PARA A TABELA 'profiles' (Inalterado)
CREATE POLICY "Admin full access" ON public.profiles FOR ALL USING (get_my_role() = 'ADMIN') WITH CHECK (get_my_role() = 'ADMIN');
CREATE POLICY "Users can manage own profile" ON public.profiles FOR ALL USING (auth.uid() = id) WITH CHECK (auth.uid() = id);


-- 6. POLÍTICAS PARA A TABELA 'trips' (Inalterado)
CREATE POLICY "Admin full access" ON public.trips FOR ALL USING (get_my_role() = 'ADMIN') WITH CHECK (get_my_role() = 'ADMIN');
CREATE POLICY "Agencies can manage their own trips" ON public.trips FOR ALL USING (auth.uid() = agency_id) WITH CHECK (auth.uid() = agency_id);
CREATE POLICY "Public can view active trips" ON public.trips FOR SELECT USING (active = true);


-- 7. POLÍTICAS ATUALIZADAS E GRANULARES PARA A TABELA 'agency_reviews'
CREATE POLICY "Admin full access" ON public.agency_reviews FOR ALL USING (get_my_role() = 'ADMIN') WITH CHECK (get_my_role() = 'ADMIN');
CREATE POLICY "Public can view reviews" ON public.agency_reviews FOR SELECT USING (true);
CREATE POLICY "Clients can create reviews for agencies they purchased from" ON public.agency_reviews FOR INSERT WITH CHECK (
  auth.uid() = client_id AND
  has_purchased_from_agency(agency_id)
);
-- CORREÇÃO: Política de UPDATE e DELETE dividida em duas para sintaxe correta.
CREATE POLICY "Clients can update their own reviews" ON public.agency_reviews FOR UPDATE USING (auth.uid() = client_id) WITH CHECK (auth.uid() = client_id);
CREATE POLICY "Clients can delete their own reviews" ON public.agency_reviews FOR DELETE USING (auth.uid() = client_id);


-- 8. POLÍTICAS PARA A TABELA 'themes' (Inalterado)
CREATE POLICY "Admin full access" ON public.themes FOR ALL USING (get_my_role() = 'ADMIN') WITH CHECK (get_my_role() = 'ADMIN');
CREATE POLICY "Authenticated users can view themes" ON public.themes FOR SELECT USING (auth.role() = 'authenticated');


-- 9. HABILITA A SEGURANÇA (RLS) NAS TABELAS
ALTER TABLE public.agencies ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.trips ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.agency_reviews ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.themes ENABLE ROW LEVEL SECURITY;

-- =============================================================================
-- FIM DO SCRIPT
-- =============================================================================
