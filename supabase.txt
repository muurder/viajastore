-- =============================================================================
-- SCRIPT DE CORREÇÃO E ATUALIZAÇÃO DO BANCO DE DADOS - VIAJASTORE
-- Execute este script no SQL Editor do Supabase.
-- =============================================================================

-- 1. Criar função RPC para criação de agência (Bypassa o cache do PostgREST)
CREATE OR REPLACE FUNCTION public.create_agency(
  p_user_id uuid,
  p_name text,
  p_email text,
  p_phone text,
  p_whatsapp text,
  p_slug text
)
RETURNS public.agencies
LANGUAGE plpgsql
SECURITY DEFINER -- Roda com privilégios de admin para garantir a inserção
SET search_path = public
AS $$
DECLARE
  new_agency public.agencies;
BEGIN
  INSERT INTO public.agencies (
    user_id,
    name,
    email,
    phone,
    whatsapp,
    slug,
    is_active -- Garante o default false explicitamente ou deixa o banco decidir
  )
  VALUES (
    p_user_id,
    p_name,
    p_email,
    p_phone,
    p_whatsapp,
    p_slug,
    false
  )
  RETURNING * INTO new_agency;

  RETURN new_agency;
END;
$$;

-- 2. Garantir permissão de execução para a API
GRANT EXECUTE ON FUNCTION public.create_agency(uuid, text, text, text, text, text) TO anon, authenticated, service_role;

-- 3. Forçar recarregamento do cache (apenas por garantia para outras rotas)
NOTIFY pgrst, 'reload config';
