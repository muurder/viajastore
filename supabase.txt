-- =============================================================================
-- SCRIPT DEFINITIVO DE POLÍTICAS DE SEGURANÇA (RLS) - VIAJASTORE
-- =============================================================================
-- Este script corrige erros de "recursão infinita" e garante as permissões corretas
-- para ADMINS, AGENCIES, e CLIENTS. É seguro executar este script múltiplas vezes,
-- pois ele remove as políticas antigas antes de recriá-las.
-- =============================================================================

-- 1. FUNÇÃO SEGURA PARA VERIFICAR O PAPEL DO USUÁRIO
-- Cria uma função `get_my_role()` que lê o papel do usuário atual sem disparar
-- a RLS da tabela 'profiles', quebrando o ciclo de recursão.
CREATE OR REPLACE FUNCTION get_my_role()
RETURNS TEXT AS $$
DECLARE
  user_role TEXT;
BEGIN
  -- Esta consulta é executada com privilégios elevados, bypassando a RLS.
  SELECT role INTO user_role
  FROM public.profiles
  WHERE id = auth.uid()
  LIMIT 1;
  RETURN user_role;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;


-- 2. LIMPEZA DE POLÍTICAS ANTIGAS (PARA GARANTIR UMA BASE LIMPA)
DROP POLICY IF EXISTS "Enable full access for admins on agencies" ON public.agencies;
DROP POLICY IF EXISTS "Admin full access on agencies" ON public.agencies;
DROP POLICY IF EXISTS "Agencies can manage their own record" ON public.agencies;
DROP POLICY IF EXISTS "Public can view active agencies" ON public.agencies;

DROP POLICY IF EXISTS "Enable full access for admins on profiles" ON public.profiles;
DROP POLICY IF EXISTS "Admin full access on profiles" ON public.profiles;
DROP POLICY IF EXISTS "Users can manage their own profile" ON public.profiles;
DROP POLICY IF EXISTS "Users can update their own profile" ON public.profiles;
DROP POLICY IF EXISTS "Users can read their own profile" ON public.profiles;


-- 3. POLÍTICAS PARA ADMINISTRADORES (ADMIN)
-- Concede permissão total (SELECT, INSERT, UPDATE, DELETE) para usuários com
-- o papel 'ADMIN' nas tabelas 'agencies' e 'profiles'.
CREATE POLICY "Admin full access on agencies"
ON public.agencies
FOR ALL USING ( get_my_role() = 'ADMIN' )
WITH CHECK ( get_my_role() = 'ADMIN' );

CREATE POLICY "Admin full access on profiles"
ON public.profiles
FOR ALL USING ( get_my_role() = 'ADMIN' )
WITH CHECK ( get_my_role() = 'ADMIN' );


-- 4. POLÍTICAS PARA AGÊNCIAS (AGENCY)
-- Permite que uma agência autenticada leia e atualize seu próprio registro.
CREATE POLICY "Agencies can manage their own record"
ON public.agencies
FOR ALL USING ( auth.uid() = id )
WITH CHECK ( auth.uid() = id );


-- 5. POLÍTICAS PARA USUÁRIOS (CLIENT)
-- Permite que um usuário autenticado leia e atualize seu próprio perfil.
CREATE POLICY "Users can read their own profile"
ON public.profiles
FOR SELECT USING ( auth.uid() = id );

CREATE POLICY "Users can update their own profile"
ON public.profiles
FOR UPDATE USING ( auth.uid() = id )
WITH CHECK ( auth.uid() = id );


-- 6. POLÍTICAS PÚBLICAS (PARA VISITANTES NÃO LOGADOS)
-- Permite que qualquer pessoa veja agências que estão ativas e não foram deletadas.
CREATE POLICY "Public can view active agencies"
ON public.agencies
FOR SELECT USING ( subscription_status = 'ACTIVE' AND deleted_at IS NULL );


-- 7. HABILITA A SEGURANÇA (RLS) NAS TABELAS
-- Garante que as políticas acima sejam aplicadas.
ALTER TABLE public.agencies ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;

-- =============================================================================
-- FIM DO SCRIPT
-- =============================================================================
